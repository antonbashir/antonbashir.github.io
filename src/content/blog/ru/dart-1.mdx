---
title: "О времени, сложности и мотивации: знакомство"
description: Мои приключения в мире Dart VM. Часть 1. 
date: "2025-04-09"
label: Article
tags: IT, Dart, Dart VM, ASM, Coroutines, Habr
time: 10 min
---
> [!NOTE]
>Приветствую вас, читатели. 
>Подозреваю, что вы из мира программирования. Приглашаю вас присоединиться к увлекательному рассказу о том, как один энтузиаст решил доработать свой любимый язык.
>Я собираюсь рассказать об увлекательном опыте внесения существенных изменений в очень сложную архитектуру кода.
>Будет несколько статей, это первая.
>Здесь мы не будем глубоко изучать технику, поэтому я заранее хочу предупредить о наличии в тексте определенных терминов, значение которых будет раскрыто в следующих частях.
> Для тех, кто хочет весь список сразу, держите:
>* [Часть 1: О времени, сложности и мотивации: знакомство](/blog/ru/dart-1)
>* [Часть 2: О времени, сложности и мотивации: такие разные функции в Dart](/blog/ru/dart-2)
>* [Часть 3: О времени, сложности и мотивации: история поражения](/blog/ru/dart-3)
>* [Часть 4: О времени, сложности и мотивации: история победы](/blog/ru/dart-4)
>* [Часть 5: О времени, сложности и мотивации: финал](/blog/ru/dart-5)

# Об авторе

Но для начала, позвольте представиться. Меня зовут Антон, и я — чайный программист-даос. 
Кто-то говорит, что программист трансформирует кофе в код, а для меня источником вдохновения является хороший китайский чай.
Скоро исполнится 10 лет, как я пью чай и пишу код. Чай разный, код тоже.
Начинал я с классического Java Backend Developer, затем добавился Groovy, Kotlin, потом был мой первый фреймворк, о котором я расскажу далее.
После JVM я познакомился с [Эльбрусом](https://habr.com/ru/companies/rostelecom/articles/562858/) и увлекательным портированием разного ПО на разных языках.
Но рассказать я хочу про последний и самый мой интересный опыт: [Dart](https://dart.dev/). На самом деле не последний, сейчас я Platform Engineer с уклоном в Golang, но рассказ пойдет про Dart.

# А зачем

Читая статьи, я редко нахожу где-нибудь в тексте информацию о том, почему автор решил эту статью вообще написать. Вот как-то не хочется быть таким автором. 
Вообще с тех пор как я написал первые строчки кода, я не помню периода в жизни, чтобы я не писал код после работы или учебы.
За 10 лет такого кода накопилось довольно прилично, и там правда есть пара интересного о чем можно было бы опубликовать.
Но каждый раз, когда я задавал себе вопроса "а зачем ?" про идею публикации, я не мог найти ответа.

В случае с этими статьями ответ нашелся: попытка достучаться.
* Достучаться до тех, кто верит в силу OpenSource и в то, что наличие открытого кода сразу открывает возможность к его массовой доработке. Я в это не верю.
* Достучаться до тех, кто не верит в то, что может сам сделать что-то важное для себя, даже если это существенное изменение своего языка. А вот в это я верю.
* Достучаться до тех, кто устал, я хочу сказать таким - а любой бы устал, потому что текущее глобальное состояние гибкости и поддерживаемости кода крайне плачевное.
* Достучаться до Dart сообщества: ребят, Dart пора вытаскивать из frontend поля, вы посмотрите на что он способен, достаточно сделать небольшое усилие, и он сможет выходить на арену backend.
* Достучаться до Dart команды (а вдруг кто-то да прочитает):
![dart-1-image-1](/dart-1-image-2.png)

Я очень люблю эту картинку, буквально регулярно сам себе её "говорю".

И не причина, но повод. 
Один мой друг как-то сказал "Статья - это тоже коммуникация", а я сейчас нахожусь в осознанном состоянии коммуникационной изоляции как раз с целью побуждения себя к более масштабным коммуникациям чем прямые сообщения в чатиках.

# О чем пойдет разговор

Итак, сейчас начинается первая глава из пяти о моем эксперименте с Dart Language и Dart VM. Планируется опубликовать пять статей.

Тематика следующая: один программист захотел добавить в язык сложную штуку. 

Давайте попробуем подумать над такой мыслью - а что если я очень люблю язык, но мне чего-то не хватает. Вот есть что-то такое, что мне бы очень хотелось в этом языке видеть. 

Я сейчас не о волшебной ИИ кнопке "напиши код за меня" а о чем-то функционально-техническом. 

Это может быть библиотека в SDK, это может быть определенная синтаксическая конструкция или особое ключевое слово, а может и целая новая механика исполнения кода этого языка.

Для меня это оказалось желание видеть реализацию корутин на языке Dart. И я смог [это](https://github.com/antonbashir/dart-fibers) сделать с кучей ограничений.

Наверное, вы подумали "ну понятно, сейчас будет очередная хвастливая история успеха о том, как разработчик сделал очередной велосипед", но уверяю вас, идея цикла статей не в этом.

Я хочу рассказать не о том, "что" было сделано, и даже не о "как", а о том, что я испытывал на разных стадиях как разработчик и человек, а также о тех причинах, которые провоцировали определенные состояния.

Будет много техники, это само собой, но идея статей про состояния.

Прежде чем я начну, давайте каждый задаст себе вопрос "а мне точно надо это читать ?". Попробую помочь с ответом.

Кому, с моей точки зрения, будет интересно: 
* разработчику, который хочет внедрить новую фичу в свой язык
* тому, кто видит Dart как нечто большее, чем runtime для Flutter
* любителям почитать про компиляторы и про "кишки" языков
* у тебя выгорание ? отвлекись, почитай, ты не одинок
* студенту, который ищет тему для ВКР

Кому может быть не очень релевантно: 
* тем, кто не занимался и не планирует заниматься вопросами внутреннего устройства языков
* Flutter-разработчикам, которые не готовы глубоко погружаться во внутренности Dart, про Flutter ничего не будет

А теперь, когда все прелюдии соблюдены, я налью себе пуэрчик и, с вашего позволения, начну этот рассказ.

# В начале было слово

И слово это было - [ART](https://github.com/art-community/art-java). Так я назвал свой первый Java/Kotlin фреймворк.

Основные особенности фреймворка:
* красиво обрабатываем HTTP/RSocket трафик
* ходим в Tarantool
* ходим (ходили) в реляционные БД 
* общаться (общались) с Kafka
* динамически применяем все изменения конфигураций

А еще он мог собираться в бинарник с помощью GraalVM. 

Я хотел решить задачу чистой, гибкой и приятной разработки Java/Kotlin сервисов. 

Без рефлексии, без байт-код модификаций, без инверсии там, где она не нужна, без аннотаций. 

Но так, чтобы разработчику было легко, без усилия создавать production-ready сервисы. В общем, типичный велосипед, ничего интересного. 

Но в какой-то момент я осознал: не только в backend есть устранимые сложности разработки. Еще есть frontend и инфраструктура. 

Так родились [art-platform](https://github.com/art-community/art-platform) и [art-react](https://github.com/art-community/art-react): еще парочка велосипедов. 

Концепция была в том, чтобы сделать единый набор инструментов разработчика: от кода до деплоя.

# Почему корутины ?

Велосипеды это хорошо, но работа есть работа. Параллельно с ночным кодингом велосипедов я работал, и по работе я познакомился со многими интересными вещами.

Среди них был Tarantool, Golang, Koishi, node-fibers, ucontext - все эти технологии связаны с красивой абстракцией под названием "корутина".

И честно признаюсь, я был очарован этой абстракцией. С тех пор, как я смог осознать корутины, я не могу выкинуть из головы их красоту и эффективность.

Что вообще такое корутина можно прочитать [тут](https://habr.com/ru/articles/850970/), [тут](https://kotlinlang.org/docs/coroutines-overview.html) и [тут](https://www.tarantool.io/en/dev/core/fiber/).

# Почему Dart ?

Оказавшись в определенном моменте разработки ART, я сформулировал ряд требований к реализации моих идей, и, к сожалению, Java под эти требования не попадала.

Одновременно с этим я случайно узнал о существовании Dart. Dart в эти требования вписывался лучше. 

Поставив точку в мире Java, я выбрал Dart следующим своим основным языком. 

О причинах:
* мне нужен один язык для native frontend (linux, windows, osx), mobile frontend (ios, android), web frontend и backend
* мне нужен сильный синтаксический аппарат, позволяющий моделировать эффективные, но простые языковые конструкции
* мне нужен компилируемый язык, я хочу поставлять один маленький бинарник без зависимостей и хочу, чтобы я мог это делать куда угодно
* мне нужен интерпретируемый язык, который позволяет динамически менять код для отладки, чтобы быстро смотреть изменения во время разработки интерфейсов
* мне нужен эффективный слой взаимодействия с native технологиями (c/c++/rust) для расширения ограничений языка
* мне нужно автоматическое управление памятью (в любом виде)

Я рассмотрел несколько вариантов на тот момент: Go, Rust, Kotlin, Nim, Crystal, V, C++, C, Dart. Выбор пал на Dart. 

Рассказ о муках выбора, критериях и оценках выходит за рамки моего материала, так что будем просто считать, что Вселенная указала мне на Dart.

# Новый путь

Прежде чем идти в очередной фреймворк, мне захотелось расширить экосистему Dart и реализовать ряд важных модулей:
* [IOUring модуль](https://github.com/antonbashir/dart-iouring-transport) - отвечает за управление Linux технологией [IOUring](https://unixism.net/loti/what_is_io_uring.html)
* [Tarantool модуль](https://github.com/antonbashir/dart-tarantool-storage) - позволяет разрабатывать под [Tarantool](https://www.tarantool.io/en/) на Dart, а не на Lua
* [RSocket модуль](https://github.com/antonbashir/dart-reactive-transport) - частичная (но достаточная для моих задач) реализация [RSocket](https://rsocket.io/) протокола на Dart

Пройдя относительно успешный путь разработки новых велосипедов, я оказался в той точке, с которой началась история "романтических" отношений Dart и корутин.

Мне понадобились корутины. И я решил их сделать.

Здесь начинается история преобразований моих внутренних состояний разработчика, да и человека тоже.

Повторюсь, я не хочу акцентировать внимание на технических особенностях разработки, а попытаться на своем примере подчеркнуть ряд проблем мира, который окружает каждого разработчика.

# Начальное состояние

Я был счастлив, осознав, какие возможности для творчества открывает Dart. 

Тут тебе и Flutter, и FFI, и SIMD, и шейдеры, и кодо-генерация, и чего еще только нет.


Я был молод и амбициозен, было все, что требовалось для того, чтобы начать увлекательный путь новой разработки в абсолютно незнакомой, но очень интересной области.

Мое состояние было такое, что мне было страшно внедрять новую модель управления кодом (корутины) в язык.

Но тяга к творчеству победила страх и, если оценить уровень решимости, то он был 100%. 

Будем считать, что 0% - ноут вылетает в окно и полное выгорание: 
![dart-1-image-1.png](/dart-1-image-1.png)


# Ну что, погнали ?

Итак, решимость есть, мотивация имеется, мозги на месте, чайный набор для кодинга готов, можем начинать.

Для начала давайте все-же подумаем, а что же не так со стабильными и удобными [async](https://dart.dev/libraries/async/async-await) функциями и future?

Заодно подсмотрим, как они работают, потому что что-то мне подсказывает, что реализация корутин будет на них очень похожа.

Ну а пока что я с вами прощаюсь, давайте сделаем перерыв, отвлечемся, развлечемся и для тех, кто готов послушать дальше - добро пожаловать во вторую [часть](/blog/ru/dart-2).

В этой части я представляю свой скромный анализ "корутины vs async".

Спасибо за внимание !