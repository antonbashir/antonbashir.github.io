---
title: О времени, сложности и мотивации-причем здесь Dart ?
description: Мои приключения в мире DartVM. Часть 1. 
date: 09-04-2025
label: Article
tags: IT, Dart, DartVM, ASM, Coroutines, Complicated
time: 10 min
---

Приветствую тебя читатель. Подозреваю, что тебе доводилось заниматься программированием на своем любимом языке, а то и не один раз. 
Ну а если ты не программист, то все равно добро пожаловать, тебе тоже будет интересно. 
Я собираюсь рассказать об увлекательном опыте внесения существенных изменений в крайне сложную структуру кода одного замечательного языка программирования.
Будет несколько статей, это первая.
Здесь мы не будем глубоко изучать технику, поэтому я заранее хочу предупредить об использовании определенных терминов, значение которых будет раскрыто в следующих частях.

# Об авторе

Но для начала, позвольте представиться, меня зовут Антон и я "чайный" программист-даос. 
Кто-то говорит, что программист трансформирует кофе в чай, а для меня источником вдохновения является хороший китайский чай.
Скоро будет 10 лет как я пью чай и пишу код. Чай разный, код тоже. 
Начинал я с классического Java Backend, затем добавился Groovy, Kotlin, потом был мой первый фреймворк, о котором я расскажу далее. 
После JVM я познакомился с Эльбрусом (здесь ссылка на статью) и увлекательным портированием разного ПО на разных языках.
Но рассказать я хочу про последний и самый мой интересный опыт - Dart. На самом деле не последний, сейчас я Golang Senior, но рассказ пойдет про Dart :)

# О чем пойдет разговор

Итак, сейчас начинается первая глава из пяти о моем эксперименте с Dart Language и Dart VM. Планируется опубликовать пять статей под одной тематикой. 
Тематика следующая: каждый программист задумывался о том, а как же работает его язык. Не с точки зрения, как именно внутри (хотя это тоже), но хотя бы частично. 
Но давайте попробуем подумать над такой мыслью - а что если я очень люблю язык, но мне чего-то не хватает. Вот есть что-то такое, что мне бы очень хотелось в этом языке видеть. 
Я сейчас не о волшебной LLM кнопке "напиши код за меня", а о чем-то функционально-техническом. 
Это может быть библиотека в SDK, это может быть определенная синтаксическая конструкция или особое ключевое слово, а может и целая новая механика исполнения кода этого языка.
Для меня это оказалось желание видеть реализацию корутин на языке Dart. И я смог это сделать с кучей ограничений (ссылка на гитхаб)
Наверное, вы подумали "ну понятно, сейчас будет очередная хвастливая история успеха о том, как разработчик сделал новую крутую штуку", но уверяю вас, идея цикла статей не в этом.
Я хочу рассказать не о том, "что" было сделано, а о том, что я испытывал на разных стадиях как разработчик и человек, а также о тех причинах, которые провоцировали определенные состояния.
Прежде чем я начну, давайте каждый задаст себе вопрос "а мне точно надо это читать ?". Попробую помочь с ответом.

Кому, с моей точки зрения, будет интересно: 
* разработчику, который хочет внедрить новую фичу в свой язык - да
* тому, кто видит Dart как нечто большое, чем runtime для Flutter - тоже да
* любителям почитать про компиляторы и про "кишки" языков - вполне
* тем, кто задумывается о состоянии общего кода в нашем великом мире программирования - определенно
* у тебя выгорание ? отвлекись, для тебя будет пара умных мыслей
* студенту, который ищет тему для ВКР

Кому может быть не очень релевантно: 
* тем, кто не занимался и не планирует заниматься вопросами внутреннего устройства языков
* Flutter разработчикам, которые не готовы глубоко погружаться во внутренности Dart, про Flutter ничего не будет

А теперь, когда все прелюдии соблюдены, я налью себе чаек и с твоего, читатель, позволения, начну этот рассказ.

# В начале было слово

И слово это был ART. Так я назвал свой первый Java(+ Kotlin)-фреймворк. 
Фреймворк умел (да и умеет) обрабатывать HTTP/RSocket трафик, ходить в Tarantool и в реляционные БД, общаться с Kafka и динамически обрабатывать все изменения конфигураций. 
А еще он мог собираться в бинарник с помощью GraalVM. 
Я хотел решить задачу чистой, гибкой и самое главное, приятной разработки Java-based сервисов. 
Без рефлексии, без байт-код модификаций, без инверсии там, где она не нужна, без аннотаций. 
Но так, чтобы разработчику было легко, без усилия создавать production-ready сервисы. 
В общем, типичный велосипед :) 
Но в какой-то момент я осознал, разработка не ограничена бекендом. Есть же фронтенд, инфраструктура. 
Так родились art-platform и art-react: еще парочка велосипедов. Концепция была в том, чтобы сделать единый набор инструментов разработчика: от кода до деплоя.

# Гитхабом сыт не будешь

Велосипеды это хорошо, но работа есть работа. За несколько лет разработки ART параллельно я работал и по работе я познакомился со многими интересными вещами. 
Среди них был Tarantool, Golang, Koishi, node-fibers, ucontext - все эти технологии связаны с абстракцией, именуемой "корутина".
И честно признаюсь, я был очарован этой абстракцией. С тех пор, как я смог осознать корутины, я не могу выкинуть из головы их красоту и эффективность.

# Почему Dart ?

Дойдя до определенной точки разработки ART у меня появился ряд требований к реализации моих идей, и, к сожалению, Java под эти требования не попадала. 
Одновременно с этим я случайно узнал о существовании Dart. Dart в эти требования (на тот момент времени) вписывался лучше. 
Поставив точку в мире Java я выбрал Dart следующим своим основным языком. 

О причинах:
* мне нужен один язык для native frontend (linux, windows, osx), mobile frontend (ios, android), web frontend и backend
* мне нужен сильный синтаксический аппарат, позволяющий моделировать нужные, но сложные конструкции и связи
* мне нужен компилируемый язык, я хочу поставлять один маленький бинарник без зависимостей и хочу, чтобы я мог это делать куда угодно
* мне нужен интерпретируемый язык, который позволяет динамически менять код для отладки, чтобы быстро смотреть изменения при, например, разработки фронтенда
* мне нужен эффективный слой совместимости с native технологиями (c/c++/rust) для расширения ограничений языка
* мне нужно автоматическое управление памятью (в любом виде)

Я рассмотрел несколько вариантов на тот момент: Go, Rust, Kotlin, Nim, V, C++, C, Dart. Выбор пал на Dart. 
Рассказ о муках выбора, критериях и оценках выходит за рамки моего материала, так что будем просто считать, что Dart хотел быть выбранным :) 

# Новый путь

Прежде чем идти в очередной фреймворк, мне захотелось расширить экосистему Dart и реализовать ряд важных модулей:
* IOUring модуль - отвечает за управление Linux технологией IOUring
* Tarantool модуль - позволяет разрабатывать под Tarantool на Dart, а не на Lua
* RSocket модуль - частичная (но достаточная для моих задач) реализация RSocket протокола на Dart

Пройдя относительно успешно путь разработки новых велосипедов (привет читателям, которые уже готовятся сказать "вот чудак, тебе нужен был простой советский... Rust, а не велосипеды клепать") 
я оказался в той точке, с которой началась история романтических отношений (иначе это не назовешь) Dart и корутин.

Почему корутины ? Антон, чего ты так привязался к ним - спросите вы. 
В следующей статье (тут ссылка на нее, надо по 2 релизить) я расскажу о том, как я пришел к тому, чтобы впихнуть в Dart невпихуемые корутины при наличии async функций. 
Спойлер: патамушта! (мем из квартета и) А если серьезно и вкратце - мне показалось крайне неоптимальным взаимодействие с Tarantool и IOURing посредством асинхронных функций. 

И здесь начинается история преобразований моих внутренних состояний разработчика, да и человека тоже. 

# Эх, а так все хорошо начиналось

Я был счастлив, осознав, какие возможности для творчества открывает Dart. Тут тебе и Flutter, и FFI, и SIMD, и шейдеры, и кодо-генерация, и чего еще только нет.
Я был молод и амбициозен, было все, что требовалось для того, чтобы начать увлекательный путь новой разработки в абсолютно незнакомой, но очень интересной области.
Мое состояние было такое, что мне было страшно, потому что внедрить новую модель управления потоком кода в язык казалось сложной и не факт, что выполнимой, задачей. 
Но тяга к творчеству победила страх и если оценить уровень решимости, то он был 100%. Будем считать, что 0% - ноут вылетает в окно и полное выгорание (мем про джс и "буду ...").

# Ну что, погнали ?

Итак, решимость есть, мотивация имеется, мозги на месте, чайный набор для церемонии готов, можем начинать.
Для начала а давайте все-же подумаем, а что же не так со стабильными и удобными async функции и future?
А заодно подсмотрим как они работают, потому что что-то мне подсказывает, что реализация корутин будет на них очень похожа.
Как и обещал - (ссылка на часть 2). 
В этой части я раскрываю свой скромный (нет, я не делал я бенчмарков и не собираюсь, потому что смысл не в том, какие они выдадут цифры на синтетике, а смысл в том, какой будет простор в случае необходимости точечных оптимизаций) анализ корутины vs future.

А пока что я с вами прощаюсь, давайте сделаем перерыв, отвлечемся, развлечемся и для тех, кто готов послушать дальше - welcome, когда будете готовы. 

Спасибо за внимание ! 