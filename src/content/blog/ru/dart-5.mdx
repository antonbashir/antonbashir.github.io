---
title: "О времени, сложности и мотивации: финал"
description: Мои приключения в мире Dart VM. Часть 5. 
date: "2025-04-24"
label: Article
tags: IT, Dart, Dart VM, ASM, Coroutines, Habr
time: 15 min
---
> [!NOTE]
>Приветствую вас, читатели. Для начала я рекомендую вам ознакомиться с [первой частью](/blog/ru/dart-1) моего цикла статей.
>В этом цикле я пишу о балансе, состояниях разработчика, корутинах и Dart.
>Все части:
>* [Часть 1: О времени, сложности и мотивации: знакомство](/blog/ru/dart-1)
>* [Часть 2: О времени, сложности и мотивации: такие разные функции в Dart](/blog/ru/dart-2)
>* [Часть 3: О времени, сложности и мотивации: история поражения](/blog/ru/dart-3)
>* [Часть 4: О времени, сложности и мотивации: история победы](/blog/ru/dart-4)
>* [Часть 5: О времени, сложности и мотивации: финал](/blog/ru/dart-5)

# Об авторе

Меня зовут Антон, и я — чайный программист-даос
Я 10 лет пишу код на разных языках, увлекаюсь даосизмом, китайским чаем и созданием никому не нужных (кроме меня) велосипедов. 
Чуть подробнее обо мне [тут](/blog/ru/dart-1).

# О времени

Ну вот мы и добрались до финала моей истории. И тем героям, кто смог здесь оказаться, я собираюсь раскрыть ключевую тему всего этого писания и подвести итоги.

Начнем со времени. 

Сколько вы потратили время на чтение этих статей в сумме ? Час, может быть, меньше. А вот на реализацию виновника всего этого чтива у меня ушло около 6-7 месяцев. 

Разумеется, это никак не 8 часов в день по 5 дней в неделю. Про такое я обычно говорю - "когда получалось, тогда и делал". 

Но я все же оцениваю эту разработку в 6 месяцев. А чтобы пояснить причину, мне нужно привести свое определение понятия "вовлеченность" и взаимосвязь этого понятия со временем. 

Вовлеченность - это потеря пустоты, спокойствия, баланса и равновесия. Моя вовлеченность означает, что я отдал контроль над своими мыслями, своим "миром" кому-то другому. Человеку, процессу, идеи - просто кому-то. 

Проблема вовлеченности в том, что она тебя гнетёт. Она разрушает. Она привязывает. Надоедает. И чем дольше ты вовлечен, тем сильнее ты получишь повреждения. 

Теперь про вовлеченность и 6 месяцев. Все эти месяцы Dart не выходил у меня из головы. Жизнь шла сама собой, её нужно было как-то жить. Работу работать и все такое. 

Но Dart... Dart все время зудел у меня в мозгах. А потом - "GC vs Anton: GC WIN! FATALITY!". И к вовлеченности добавилось ещё много неприятных ощущений, поэтому 6 месяцев. 

В чем мораль ? Управляйте своим вниманием. Не позволяйте перейти ту грань, когда умеренное внимание превращается в безграничную вовлеченность. Потому что ваше время - это ваше внимание. 

И про Dart, да. Я благодарен Dart за то, что его архитектура и специфика кода научили меня постоянно, в каждом своем шаге, в каждом проекте, оценивать уровень своей вовлеченности. 

# О сложности

Кодили после работы ? Если да, вам знакомо это состояние. 

Вы утром проснулись, добрались до рабочего пространства, кое-как смогли войти в поток, вышли из него ближе к вечеру иииии вам нужно войти в новый поток.

Другой проект, другой код, другой контекст, да все другое. Но вам нужно. Не потому что вас заставляют, потому что пока вы пишите свой код, свой проект - вы чувствуете себя другим, как-то, лучше что ли чувствуете. 

В чем здесь проблема ? 

Очевидно, в усталости. У вас банально нет ресурсов на то, чтобы снова что-то кодить. Не говоря уже о кардинальной смене контекста. Но, предположим, вы смогли эти ресурсы найти и засели за работу на несколько часов.

Возьмем два варианта развития событий:
1. У вас был заранее заготовлен список задач, которые вам нужно выполнить. Вы его выполнили и с чистой совестью пошли спать
2. У вас был заранее заготовлен список задач, которые вам нужно выполнить. Где-то в середине выполнения вы столкнулись с ним. С ужасным и жутким монстром - "плавающий" баг!

С первым сценарием все понятно, программист-красавчик все сделал и пошел отдыхать. 

А второй ? Узнаете себя ? 3 часа ночи, монитор слепит в лицо, вы прикидываете, сколько вам осталось спать и успеете ли вы "бахнуть" кофе перед работой утром.

У меня были крайне глупые, но смешные моменты, когда я сидел до 3-4 утра, психовал, шел спать, а потом утром перед работой за час фиксил все плавающие баги. Почему ? Да банально отдохнул, ну. 

Когда живешь в таком режиме 10 лет (сначала учеба - ночной кодинг, потом работа - ночной кодинг), начинаешь фиксировать такие ситуации, анализировать их, искать какие-то решения вот таких вот проблем. 

Так вот, про Dart. Думаю, не нужно говорить, что самым очевидным источником таких проблем в случае с Dart - сложность его внутренностей. Сложность кода. 

Не отдельных функций или объектов, а глобальная сложность внесения изменений в него. 

Сложность в том, что нужно в нескольких местах зафиксировать изменения, связанные с одной задачей. 

Сложность в том, что у тебя банально половина на Dart, половина на C++ и мозг постоянно переключает контекст (прям как процессор между корутинами, ага). 

Сложность в мелочах: тут надо генератор запустить, тут у тебя компилятор упадет, и это ок, потому что надо поправить файл, используя данные из ошибки (кстати, может есть способ лучше, пишите, если знаете), а тут вообще у тебя `SegmentationFault` и ты не можешь понять, правильный ли у тебя регистр `RSP` или все же его кто-то испортил. 

Сложность в конфигурациях сборки: по правде говоря, я не сразу смог заставить Dart в debug режиме показывать мне информацию по debug символам в запуске кода из VSCode.

Конечно, вы можете сказать: "А что ты хотел ? Ты зашел в чужой район, взял не свой вес, дружище", и будете правы. 

Но сколько ещё мне таких "весов" нужно взять, прежде чем будет тот самый, последний, после которого я "сорву спину" ? 

Или не я...

[Пишите простой код](https://habr.com/ru/articles/903426/), друзья, пишите простой код. 

# О мотивации

А вот с мотивацией все вообще просто. Она закончилась почти сразу :) 

Серьезно, неужели вам показалось, что я горел огнем, когда ждал debug сборку по много минут. Ну, я-то горел, но не глазами. Или когда GC набил мне морду. 

Кстати, про GC. Глупо получилось, вообще не спорю. 

Надо было с самого начала разобраться в том, как работает GC в Dart. 

А ещё в Tagged Objects, Write Barriers, recognized methods, external methods, native methods, stubs, runtime entries, instructions, snapshots, threads, isolates... ну вы поняли. 

А вы думаете, мне это интересно ? 

Разбираться в том, как работает другая технология, ради того, чтобы сделать то, что я уже давно представил в своей голове. Копаться в коде на плюсах, который вызывается из кода на Dart и генерирует код на языке ассемблера.

Вам в процессе прочтения показалось, что я испытал гамму прекрасных ощущений в процессе исследования абсолютно новой и непонятной предметной области ?

Нет её, мотивации. Закончилась, истончилась, пропала, потерялась, умерла, аннигилировалась, исчезла, испарилась, обесточилась и расщепилась. 

Стоит здесь сказать такую вещь. Я правда люблю свою область, направление, программная инженерия и вот это вот все. Без любви я бы не стал копаться в таком объеме языков и делать все свои поделки. 

Но вот эти исследования убивают все желание. Не у всех, разумеется. Есть те, кому в кайф вот именно исследовать. Такие люди ещё восхищаются той сложностью, про которую я выше писал. Но я не из таких, да и многие не из таких. 

Мы хотим придумывать и реализовывать. Исследовать мы вынуждены.  

# Финал

Теперь пару слов про Dart без всяких философских характеристик. Ну и вывод надо бы сделать, какой-нибудь адекватный, да ? 

Я сделал [корутины](https://github.com/antonbashir/dart/pull/3/files) в Dart. Они работают. С багами, да. Не скажу, что я про них знаю, я стараюсь не вовлекаться сейчас в это.

Кстати, первую версию с GC багом можете почитать [тут](https://github.com/antonbashir/dart/pull/4).

И кое-какие аспекты не реализованы совсем. Давайте расскажу о них. Список отсортирован в порядке важности с моей точки зрения. 

## JIT

Dart реализован в AOT и JIT режимах. Для AOT корутины работают, а в JIT нет. 

Потому что в тот момент, когда мы меняем стеки корутин, нужно выполнить деоптимизацию кода при определенных условиях (я сделал такой вывод, изучая `ResumeStub`).

## Debug

Допустим, мы сделали JIT и теперь можем отлаживать Dart с корутинами. Что будет, когда мы поставим точку останова на строчку `Fiber.suspend` ? Или на строчку после `Fiber.suspend`. 

Я не знаю, потому что, чтобы ответить, мне нужно проанализировать Dart Debugger. Я могу пофантазировать, но в случае с Dart я решил, что нельзя выдумывать, а нужно сразу идти в код.Я не знаю, потому что, чтобы ответить, мне нужно проанализировать Dart Debugger.

## ARM и RISCV

Сейчас корутины работают под x64 архитектуру, но их нужно реализовать под все архитектуры, которые поддерживает Dart. Но делать это нужно после того, как на x64 заработают все фичи и будут нужные тесты.

## Foreign Function Interface (FFI)

Мне очень хотелось бы видеть такие корутины, которые могут быть приостановлены в Dart и возобновлены в C, но это нужно сделать. 

## Оптимизация

В идеале я бы хотел взять 2-3 языка программирования, изучить особенности реализации корутин там, выявить недостатки в своей архитектуре, оптимизировать её. 

Затем написать микро-бенчмарки, сформулировать критерии и локально оптимизировать код под них.

## JS и WASM

Dart прекрасно работает в web. С корутинами вопрос открытый - а нужно ли ? Но тогда код будет не очень портабельным, так что в каком-то виде точно надо.

## Upstream ?

Пожалуй, здесь я и поставлю жирную точку в своем повествовании. 

Upstream, pull-request, подведение API под [спецификацию](https://github.com/dart-lang/language/blob/main/working/333%20-%20shared%20memory%20multithreading/proposal.md#coroutines), вклад в OpenSource и так далее.

Да, нужно. Я согласен, нужно. Но давайте подумаем. Нужно кому ? Я не смог найти в сети какой-нибудь опросник, в котором Dart Team спрашивала у сообщества: "Вам корутины нужны ?". 

Да в PR к спецификации было обсуждение этого вопроса, но я хочу спросить у Вселенной: а кто вообще решает, что нужно Dart и в каком виде ? 

Нужно ли это лично мне ? 6 месяцев назад - очень сильно, сейчас - разве что та самая идея "каждый вносит свой вклад" не позволяет окончательно отбросить эту мысль. Но у меня есть сомнения на тему эффективности этой мысли. 

Возможно, мои обстоятельства поменяются так, что у меня появится достаточная мотивация сделать все эти фичи, актуализировать под upstream и выставить туда pull-request. Самое главное - смогу ли я это сделать без вовлеченности.

Однако, прямо сейчас я не готов это утверждать. Мне слишком нравится то новое, о чем я стал размышлять. И оно не связано c Dart.

Так что да, я определенно вижу смысл в добавлении корутин в upstream. Но это я. А что же скажет мой уважаемый Читатель ? Быть корутинам в Dart или не быть ? 

Кто ты: хозяин своего мира или слуга своей вовлеченности ?

Спасибо за внимание !